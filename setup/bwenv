#!/usr/bin/env bash
# Global Bitwarden + direnv CLI
# Usage: bwenv init | bwenv interactive | bwenv remove

LIB_DIR="$HOME/.config/direnv/lib"
HELPER_SCRIPT="$LIB_DIR/bitwarden_folders.sh"

# Provjeri da li helper postoji
if [ ! -f "$HELPER_SCRIPT" ]; then
  echo "‚ö†Ô∏è Helper script not found in $HELPER_SCRIPT"
  echo "Run 'make install' first."
  exit 1
fi

# Source helper
source "$HELPER_SCRIPT"

# Funkcija za generiranje .envrc
generate_envrc() {
  local folder_name="$1"
  local debug_level="${BWENV_DEBUG:-1}"  # Default to level 1 (steps only)
  
  {
    echo "# Bitwarden environment variables"
    echo "export BW_SESSION=$BW_SESSION # Required for Bitwarden access"
    echo ""
    echo "# Debug levels:"
    echo "#   BWENV_DEBUG=0: No debug output" 
    echo "#   BWENV_DEBUG=1: Show steps only (default)"
    echo "#   BWENV_DEBUG=2: Show steps and secrets (full debug)"
    echo "export BWENV_DEBUG=$debug_level"
    echo ""
    echo "# Load Bitwarden integration"
    echo "use bitwarden_folders"
    echo "load_bitwarden_folder_vars \"$folder_name\""
  } > .envrc
  
  echo "‚úÖ .envrc created in $(pwd) using folder: $folder_name"
  echo "üìù Debug level set to: $debug_level (1=steps only, 2=full debug)"
  echo "üîÑ Run 'direnv allow' to load variables"
}

# Parse debug level from arguments
debug_level=1  # Default
case "$1" in
  --debug=*)
    debug_level="${1#*=}"
    shift
    ;;
  --debug)
    debug_level=2
    shift
    ;;
  --quiet|-q)
    debug_level=0
    shift
    ;;
esac

# Set environment for this session
export BWENV_DEBUG="$debug_level"

case "$1" in
  init)
    if ! command -v bw >/dev/null 2>&1; then
      echo "‚ùå Bitwarden CLI is not installed." >&2
      exit 1
    fi

    echo "üîÑ Syncing Bitwarden vault..."
    if ! bw sync >/dev/null 2>&1; then
      echo "‚ö†Ô∏è Bitwarden sync failed (this is usually okay)"
    fi

    # Ruƒçni unos foldera
    read -p "üì¶ Enter Bitwarden folder name to load secrets from: " folder_name
    if [ -z "$folder_name" ]; then
      echo "‚ö†Ô∏è Folder name cannot be empty."
      exit 1
    fi

    # Unlock session
    if [ -z "$BW_SESSION" ]; then
      echo "üîë Unlocking Bitwarden vault..."
      export BW_SESSION=$(bw unlock --raw)
      echo "‚úÖ BW_SESSION obtained"
    fi

    generate_envrc "$folder_name"
    ;;

  interactive)
    if ! command -v bw >/dev/null 2>&1; then
      echo "‚ùå Bitwarden CLI is not installed." >&2
      exit 1
    fi

    echo "üîÑ Syncing Bitwarden vault..."
    if ! bw sync >/dev/null 2>&1; then
      echo "‚ö†Ô∏è Bitwarden sync failed (this is usually okay)"
    fi

    # Unlock session
    if [ -z "$BW_SESSION" ]; then
      echo "üîë Unlocking Bitwarden vault..."
      export BW_SESSION=$(bw unlock --raw)
      echo "‚úÖ BW_SESSION obtained"
    fi

    # Dohvati sve foldere i prika≈æi s brojevima
    echo "üìÇ Fetching available folders..."
    folders=$(bw list folders --session "$BW_SESSION" | jq -r '.[].name')
    if [ -z "$folders" ]; then
      echo "‚ö†Ô∏è No folders found in Bitwarden."
      exit 1
    fi

    echo "üìÇ Available folders:"
    i=1
    declare -A map
    for f in $folders; do
      echo " $i) $f"
      map[$i]="$f"
      i=$((i+1))
    done

    # Odabir brojem
    read -p "Select folder number: " choice
    folder_name="${map[$choice]}"
    if [ -z "$folder_name" ]; then
      echo "‚ö†Ô∏è Invalid choice."
      exit 1
    fi

    generate_envrc "$folder_name"
    ;;

  remove)
    echo "üßπ Removing .envrc in $(pwd)..."
    rm -f .envrc
    echo "‚úÖ .envrc removed"
    ;;

  test)
    # Test mode - verify installation and direnv functionality
    echo "üß™ Testing bwenv installation..."
    
    # Check dependencies
    echo "üìã Checking dependencies:"
    if command -v bw >/dev/null 2>&1; then
      echo "  ‚úÖ Bitwarden CLI: $(bw --version 2>/dev/null || echo 'installed')"
    else
      echo "  ‚ùå Bitwarden CLI: not installed"
    fi
    
    if command -v jq >/dev/null 2>&1; then
      echo "  ‚úÖ jq: $(jq --version 2>/dev/null || echo 'installed')"
    else
      echo "  ‚ùå jq: not installed"  
    fi
    
    if command -v direnv >/dev/null 2>&1; then
      echo "  ‚úÖ direnv: $(direnv version 2>/dev/null || echo 'installed')"
    else
      echo "  ‚ùå direnv: not installed"
    fi
    
    # Check direnv hook
    echo "üìã Checking direnv hook configuration:"
    if [ -f ~/.bashrc ] && grep -q "direnv hook" ~/.bashrc; then
      echo "  ‚úÖ direnv hook found in ~/.bashrc"
    elif [ -f ~/.zshrc ] && grep -q "direnv hook" ~/.zshrc; then
      echo "  ‚úÖ direnv hook found in ~/.zshrc"  
    else
      echo "  ‚ö†Ô∏è  direnv hook not found in shell config"
      echo "     Run 'make install' again to set up the hook"
    fi
    
    # Check helper script
    if [ -f "$HELPER_SCRIPT" ]; then
      echo "  ‚úÖ Helper script: $HELPER_SCRIPT"
    else
      echo "  ‚ùå Helper script: not found at $HELPER_SCRIPT"
    fi
    
    # Check BW_SESSION
    if [ -n "$BW_SESSION" ]; then
      echo "  ‚úÖ BW_SESSION: set"
      if bw list folders --session "$BW_SESSION" >/dev/null 2>&1; then
        echo "  ‚úÖ BW_SESSION: valid"
      else
        echo "  ‚ùå BW_SESSION: invalid or expired"
      fi
    else
      echo "  ‚ö†Ô∏è  BW_SESSION: not set"
    fi
    ;;

  *)
    echo "Usage:"
    echo "  bwenv [--debug[=LEVEL]|--quiet] init          - Manual folder input"
    echo "  bwenv [--debug[=LEVEL]|--quiet] interactive   - Interactive folder selection"
    echo "  bwenv remove                                  - Remove .envrc"
    echo "  bwenv test                                    - Test installation"
    echo ""
    echo "Debug options:"
    echo "  --quiet, -q     No debug output (BWENV_DEBUG=0)"
    echo "  --debug         Full debug with secrets (BWENV_DEBUG=2)"  
    echo "  --debug=1       Show steps only, hide secrets (default)"
    echo "  --debug=2       Show steps and secrets (full debug)"
    exit 0
    ;;
esac