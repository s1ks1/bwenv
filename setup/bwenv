#!/usr/bin/env bash
# bwenv - Bitwarden + direnv CLI
# Usage: bwenv init | bwenv interactive | bwenv remove | bwenv test

BWENV_VERSION="1.1.1"
LIB_DIR="$HOME/.config/direnv/lib"
HELPER_SCRIPT="$LIB_DIR/bitwarden_folders.sh"

# Search multiple locations for the helper script
_find_helper() {
  # 1. User config (standard)
  if [ -f "$HOME/.config/direnv/lib/bitwarden_folders.sh" ]; then
    echo "$HOME/.config/direnv/lib/bitwarden_folders.sh"; return 0
  fi
  # 2. Homebrew prefix
  if command -v brew >/dev/null 2>&1; then
    local brew_share
    brew_share="$(brew --prefix)/share/bwenv/bitwarden_folders.sh"
    if [ -f "$brew_share" ]; then
      echo "$brew_share"; return 0
    fi
  fi
  # 3. System-wide
  for d in /usr/local/share/bwenv /usr/share/bwenv; do
    if [ -f "$d/bitwarden_folders.sh" ]; then
      echo "$d/bitwarden_folders.sh"; return 0
    fi
  done
  return 1
}

# Ensure helper is in ~/.config/direnv/lib (direnv needs it there)
_ensure_helper() {
  if [ -f "$HELPER_SCRIPT" ]; then
    return 0
  fi
  local found
  found=$(_find_helper) || {
    echo "Error: Helper script not found." >&2
    echo "Run the installer again or 'make install'." >&2
    return 1
  }
  mkdir -p "$LIB_DIR"
  cp "$found" "$HELPER_SCRIPT"
  chmod +x "$HELPER_SCRIPT"
  echo "Copied helper script to $HELPER_SCRIPT"
}

# Ensure jq is available, auto-install if possible
_ensure_jq() {
  command -v jq >/dev/null 2>&1 && return 0
  echo "jq is not installed. Attempting to install..."
  if [ "$(uname -s)" = "Darwin" ]; then
    if command -v brew >/dev/null 2>&1; then
      brew install jq && return 0
    fi
  else
    if command -v apt-get >/dev/null 2>&1; then
      sudo apt-get install -y jq && return 0
    elif command -v dnf >/dev/null 2>&1; then
      sudo dnf install -y jq && return 0
    elif command -v pacman >/dev/null 2>&1; then
      sudo pacman -S --noconfirm jq && return 0
    elif command -v apk >/dev/null 2>&1; then
      sudo apk add jq && return 0
    fi
  fi
  echo "Error: Could not install jq automatically." >&2
  echo "Please install jq manually: https://stedolan.github.io/jq/" >&2
  return 1
}

# Generate .envrc file
generate_envrc() {
  local folder_name="$1"
  local debug_level="${BWENV_DEBUG:-1}"

  {
    echo "# Generated by bwenv - do not edit manually"
    echo "export BW_SESSION=\"$BW_SESSION\""
    echo "export BWENV_DEBUG=$debug_level"
    echo ""
    echo "# Suppress direnv slow-execution warning"
    echo "export DIRENV_WARN_TIMEOUT=600"
    echo ""
    echo "# Load Bitwarden integration"
    echo "use bitwarden_folders"
    echo "load_bitwarden_folder_vars \"$folder_name\""
  } > .envrc

  echo ""
  echo "  SUCCESS"
  echo "  .envrc created in: $(pwd)"
  echo "  Using folder: $folder_name"
  echo "  Debug level: $debug_level"
  echo ""
  echo "  Next step: Run 'direnv allow' to load variables"
  echo ""
}

# Parse debug level from arguments
debug_level=1
case "$1" in
  --debug=*)
    debug_level="${1#*=}"
    shift
    ;;
  --debug)
    debug_level=2
    shift
    ;;
  --quiet|-q)
    debug_level=0
    shift
    ;;
esac

export BWENV_DEBUG="$debug_level"

case "$1" in
  init)
    if ! command -v bw >/dev/null 2>&1; then
      echo "Error: Bitwarden CLI is not installed." >&2
      echo "  Install from: https://bitwarden.com/help/cli/" >&2
      exit 1
    fi

    _ensure_jq || exit 1
    _ensure_helper || exit 1

    echo "Syncing Bitwarden vault..."
    bw sync >/dev/null 2>&1 || true

    read -p "Enter Bitwarden folder name: " folder_name
    if [ -z "$folder_name" ]; then
      echo "Error: Folder name cannot be empty." >&2
      exit 1
    fi

    if [ -z "$BW_SESSION" ]; then
      echo "Unlocking Bitwarden vault..."
      BW_SESSION=$(bw unlock --raw) || { echo "Error: Failed to unlock vault." >&2; exit 1; }
      export BW_SESSION
      echo "Session obtained."
    fi

    generate_envrc "$folder_name"
    ;;

  interactive)
    if ! command -v bw >/dev/null 2>&1; then
      echo "Error: Bitwarden CLI is not installed." >&2
      echo "  Install from: https://bitwarden.com/help/cli/" >&2
      exit 1
    fi

    _ensure_jq || exit 1
    _ensure_helper || exit 1

    echo "Syncing Bitwarden vault..."
    bw sync >/dev/null 2>&1 || true

    if [ -z "$BW_SESSION" ]; then
      echo "Unlocking Bitwarden vault..."
      BW_SESSION=$(bw unlock --raw) || { echo "Error: Failed to unlock vault." >&2; exit 1; }
      export BW_SESSION
      echo "Session obtained."
    fi

    echo "Fetching folders..."
    folders_json=$(bw list folders --session "$BW_SESSION" 2>/dev/null)
    if [ -z "$folders_json" ] || [ "$folders_json" = "[]" ]; then
      echo "No folders found in Bitwarden." >&2
      exit 1
    fi

    echo ""
    echo "Available folders:"
    local_count=$(echo "$folders_json" | jq -r 'length')
    i=0
    while [ "$i" -lt "$local_count" ]; do
      name=$(echo "$folders_json" | jq -r ".[$i].name")
      echo "  $((i+1))) $name"
      i=$((i+1))
    done

    echo ""
    read -p "Select folder number: " choice
    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "$local_count" ]; then
      echo "Error: Invalid choice." >&2
      exit 1
    fi

    folder_name=$(echo "$folders_json" | jq -r ".[$((choice-1))].name")
    generate_envrc "$folder_name"
    ;;

  remove)
    if [ -f .envrc ]; then
      rm -f .envrc
      echo ".envrc removed from $(pwd)"
    else
      echo "No .envrc found in $(pwd)"
    fi
    ;;

  test)
    echo "bwenv v${BWENV_VERSION} - Installation test"
    echo ""
    echo "Dependencies:"
    if command -v bw >/dev/null 2>&1; then
      echo "  [OK] Bitwarden CLI: $(bw --version 2>/dev/null || echo 'installed')"
    else
      echo "  [MISSING] Bitwarden CLI"
    fi

    if command -v jq >/dev/null 2>&1; then
      echo "  [OK] jq: $(jq --version 2>/dev/null || echo 'installed')"
    else
      echo "  [MISSING] jq (will be auto-installed on first use)"
    fi

    if command -v direnv >/dev/null 2>&1; then
      echo "  [OK] direnv: $(direnv version 2>/dev/null || echo 'installed')"
    else
      echo "  [MISSING] direnv"
    fi

    echo ""
    echo "Configuration:"
    # Check helper script in all locations
    helper_found=$(_find_helper 2>/dev/null)
    if [ -n "$helper_found" ]; then
      echo "  [OK] Helper script: $helper_found"
      if [ ! -f "$HELPER_SCRIPT" ] && [ "$helper_found" != "$HELPER_SCRIPT" ]; then
        echo "       (will be copied to $LIB_DIR on first use)"
      fi
    else
      echo "  [MISSING] Helper script"
    fi

    # Check direnv hook
    hook_found=false
    for rc in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.config/fish/config.fish"; do
      if [ -f "$rc" ] && grep -q "direnv hook\|direnv hook" "$rc" 2>/dev/null; then
        echo "  [OK] direnv hook found in $(basename "$rc")"
        hook_found=true
        break
      fi
    done
    if [ "$hook_found" = "false" ]; then
      echo "  [WARN] direnv hook not found in shell config"
    fi

    # Check BW_SESSION
    if [ -n "$BW_SESSION" ]; then
      echo "  [OK] BW_SESSION: set"
      if bw list folders --session "$BW_SESSION" >/dev/null 2>&1; then
        echo "  [OK] BW_SESSION: valid"
      else
        echo "  [WARN] BW_SESSION: invalid or expired"
      fi
    else
      echo "  [INFO] BW_SESSION: not set (will be requested on first use)"
    fi
    ;;

  version|--version|-v)
    echo "bwenv $BWENV_VERSION"
    ;;

  *)
    echo "Usage: bwenv [OPTIONS] COMMAND"
    echo ""
    echo "Commands:"
    echo "  init          Initialize secrets (manual folder input)"
    echo "  interactive   Initialize secrets (choose from list)"
    echo "  remove        Remove .envrc from current directory"
    echo "  test          Verify installation and dependencies"
    echo "  version       Show version"
    echo ""
    echo "Options:"
    echo "  --quiet, -q   No debug output (BWENV_DEBUG=0)"
    echo "  --debug       Full debug with secrets (BWENV_DEBUG=2)"
    echo "  --debug=1     Show steps only, hide secrets (default)"
    echo "  --debug=2     Show steps and secrets (full debug)"
    exit 0
    ;;
esac